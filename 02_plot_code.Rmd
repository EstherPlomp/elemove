---
output: html_document
editor_options: 
  chunk_output_type: console
---

## Load libraries

```{r}
# load libraries
library(sf)
library(ggplot2)
library(ggspatial)
library(pals)
library(rnaturalearth)
library(data.table)
library(scico)
```

## Load data

```{r}
# prepare bounding box
bbox <- c(xmin = 357000,
          xmax = 385050,
          ymin = 7275000, 
          ymax = 7303050)
bbox_sf <- st_bbox(bbox)
bbox_sf <- st_as_sfc(bbox_sf)
st_crs(bbox_sf) <- 32736
```

```{r}
# get data
data <- st_read("data/data_lines_elephants.gpkg")

# get count data
data_count <- fread("data/data_ele_count.csv")

# get data 253
data_253 <- data[data$id == "AM253", ]

# get other data
data_rest <- data[data$id %in% c("AM255", "AM99"), ]

# get kruger data
kruger <- st_read("data/kruger_clip/kruger_clip.shp")
kruger <- st_transform(kruger, 32736)
```

```{r}
# get za
za <- st_read("data/za_boundary.gpkg")
```

```{r}
# get rivers
rivers <- st_read("data/river_crop/")

# river buffer
river_buffer <- st_transform(rivers[is.na(rivers$seasonal), ], 32736)
river_buffer <- st_crop(river_buffer, bbox)
river_buffer <- st_buffer(river_buffer, 200)
river_buffer <- st_union(river_buffer)

# waterholes
waterholes <- st_read("data/waterholes/")
```

```{r}
# get slope
library(raster)
# elev <- raster::raster("data/kruger_elevation_UTM.tif")
# res_init <- res(elev)
# 
# # res to transform to 1000m
# res_final <- res_init * 200 / res_init
# 
# # use gdalutils gdalwarp for resampling transform
# # to 1km from 10m
# gdalUtils::gdalwarp(
#   srcfile = "data/kruger_elevation_UTM.tif",
#   dstfile = "data/kruger_elevation_200m.tif",
#   tr = c(res_final), r = "average", 
#   te = c(bbox(elev))
# )

res_init <- res(raster("data/kruger_temperature_UTM.tif"))
res_final <- res_init * 200 / res_init
gdalUtils::gdalwarp(
  srcfile = "data/kruger_temperature_UTM.tif",
  dstfile = "data/kruger_temp_200m.tif",
  tr = c(res_final), r = "average", 
  te = c(bbox(raster("data/kruger_temperature_UTM.tif")))
)

# read in cropped raster
# elev <- raster("data/kruger_elevation_200m.tif")
temp <- raster("data/kruger_temp_200m.tif")

# crop
elev <- raster::crop(elev, as(bbox_sf, "Spatial"))
elev <- cbind(coordinates(elev), values(elev))
elev <- data.table(elev)

temp <- raster::crop(temp, as(bbox_sf, "Spatial"))
temp <- cbind(coordinates(temp), values(temp))
temp <- data.table(temp)
temp <- temp[V3 > 15, ]
```

## Make main plot

```{r}
# make plot
fig_main <-
  ggplot()+
  geom_tile(
    data = temp,
    aes(x, y, fill = V3),
    show.legend = FALSE,
    # col = "grey",
    alpha = 0.4
  )+
  geom_sf(
    data = waterholes,
    col = scico::scico(5,
                       palette = "nuuk")[1],
    alpha = 0.35
    # col = "grey"
  )+
  geom_sf(
    data = river_buffer,
    col = NA,
    fill = scico::scico(5,
                       palette = "nuuk")[3],
    alpha = 0.2
  )+
  geom_sf(
    data = rivers[is.na(rivers$seasonal), ],
    lwd = 1,
    col = scico::scico(3,
                       palette = "nuuk")[1],
    alpha = 0.35
  )+
  geom_sf(data = data_rest,
          lwd = c(0.15, 0.2),
          lty = 1,
          alpha = c(0.4, 0.8),
          col = scico::scico(7,
                        palette = "turku")[c(3, 4)])+
  geom_sf(data = data_253,
          lwd = 0.2,
          alpha = 1,
          col = scico::scico(7,
                        palette = "bilbao")[6])+
  geom_sf(
    data = waterholes,
    col = scico::scico(5,
                       palette = "nuuk")[1],
    alpha = 0.35
    # col = "grey"
  )+
  scale_fill_gradientn(
    # colours = scico(10, palette = "lapaz",
    #                 direction = 1,
    #                 begin = 0., end = 1)
    colours = rev(RColorBrewer::brewer.pal(9, "RdYlBu"))
  )+
  annotation_north_arrow(
    style = north_arrow_minimal(text_family = "IBM Plex Sans", 
                                text_size = 20, 
                                text_col = "grey30", 
                                line_col = "grey30", 
                                fill = "grey30"),
    location = "br"
  )+
  annotation_scale(
    bar_cols = c("grey30", "grey90")
  )+
  theme_void()+
  theme(
    panel.background = element_rect(
      colour = "black",
      fill = "grey90"
    )
  )+
  coord_sf(
    xlim = bbox[c("xmin", "xmax")],
    ylim = bbox[c("ymin", "ymax")],
    expand = FALSE
  )
```

## Make where plot

```{r}
fig_inset_a <-
  ggplot()+
  geom_sf(
    data = za,
    fill = "tan3",
    alpha = 0.5,
    col = NA
  )+
  annotate(
    geom = "point",
    x = 31.5,
    y = -24,
    size = 10,
  )+
  scale_y_continuous(
    breaks = seq(-22, -34, -6)
  )+
  theme_void(base_size = 8)+
  theme(
    panel.background = element_rect(
      fill = "aliceblue",
      colour = "grey20"
    ),
    # axis.ticks = element_line(),
    axis.ticks.length = unit(2, units = "mm"),
    axis.text.y = element_text(margin = margin(r = -25)),
    axis.text.x = element_text(margin = margin(t = -20)),
    panel.grid = element_line(colour = "grey40", 
                              size = 0.1),
    text = element_text(
      family = "IBM Plex Sans"
    ), 
    plot.margin = unit(rep(2, 4), "mm")
  )+
  coord_sf(
    xlim = c(12, 37),
    ylim = c(-36, -20),
    expand = FALSE
  )
```


## Make count plot

```{r}
fig_inset_b <-
  ggplot()+
  geom_sf(
    data = kruger,
    fill = "tan4",
    alpha = 0.2,
    col = NA,
    lwd = 0.2
  )+
  # geom_tile(data = data_count,
  #           aes(xutm, yutm,
  #               fill = N),
  #           lwd = 0.1,
  #           # col = "grey",
  #           show.legend = FALSE)+
  geom_sf(
    data = data,
    lwd = c(0.1),
    lty = 1,
    alpha = c(0.4),
    col = scico::scico(7,
                       palette = "bilbao")[c(6)]
  )+
  scico::scale_fill_scico(
    palette = "bilbao",
    begin = c(0.2), 
    direction = 1,
    trans = "log10"
  )+
  annotation_north_arrow(
    style = north_arrow_minimal(
      text_family = "IBM Plex Sans", 
      text_size = 20, 
      text_col = "grey30", 
      line_col = "grey30", 
      fill = "grey30"),
    location = "br"
  )+
  annotation_scale(
    bar_cols = c("grey30", "grey90")
  )+
  theme_void()+
  coord_sf(crs = 32736,
           expand = FALSE,
           xlim = c(325000, NA)#,
           # ylim = c(7213050, 7335050)
           )+
  theme(
    panel.background = element_rect(
      colour = "grey20",
      size = 0.2,
      fill = "cornsilk"
    ),
    plot.margin = unit(rep(2, 4), "mm")
  )
```

bbox <- c(xmin = ,
          xmax = 385050,
          ymin = 7275000, 
          ymax = 7303050)
## Marge plots

```{r}
library(patchwork)
```


```{r}
wrap_plots(fig_inset_b, fig_main, 
           design = "AB")
  plot_annotation(
    theme(
      plot.background = element_render(
        fill = "grey90"
      )
    ) 
  )
```


